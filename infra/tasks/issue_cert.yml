- name: Ensure ACME webroot exists
  file:
    path: /var/www/html/.well-known/acme-challenge
    state: directory
    owner: www-data
    group: www-data
    mode: "0755"

- name: Obtain Let's Encrypt certificate
  command: >
    certbot certonly --webroot
    -w /var/www/html
    --non-interactive --agree-tos
    -m {{ email }}
    -d {{ domain }}
  args:
    creates: /etc/letsencrypt/live/{{ domain }}/fullchain.pem

- name: Ensure daily certbot renewal cron exists
  cron:
    name: "Certbot renew and reload Nginx"
    user: root
    minute: "0"
    hour: "3"
    job: "certbot renew --quiet --deploy-hook 'systemctl reload nginx'"
    state: present
