- hosts: all
  become: yes

  tasks:
    - name: Update APT and upgrade packages
      apt:
        update_cache: yes
        upgrade: dist

    - name: Ensure user
      user:
        name: "{{ username }}"
        groups: sudo
        shell: /bin/bash
    
    - name: Add user SSH key
      authorized_key:
        user: "{{ username }}"
        key: "{{ lookup('file', ssh_public_key_path) }}"
    
    - name: Allow sudo
      copy:
        dest: "/etc/sudoers.d/{{ username }}"
        content: "{{ username }} ALL=(ALL) NOPASSWD:ALL"
        owner: root
        group: root
        mode: '0440'
    
    - name: Disable root SSH login
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PermitRootLogin'
        line: 'PermitRootLogin no'
      notify: Restart SSH
    
  handlers:
    - name: Restart SSH
      service:
        name: ssh
        state: restarted